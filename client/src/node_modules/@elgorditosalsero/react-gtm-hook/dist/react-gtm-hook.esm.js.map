{"version":3,"file":"react-gtm-hook.esm.js","sources":["../src/utils/snippets.ts","../src/utils/GoogleTagManager.ts","../src/index.tsx"],"sourcesContent":["import { ICustomEnvironmentParams, IDataLayer, ISnippets, ISnippetsParams } from '../models/GoogleTagManager'\n\nexport const DEFAULT_DOMAIN = 'https://www.googletagmanager.com'\nexport const DEFAULT_SCRIPT_NAME = 'gtm.js'\n\n/**\n * Function to get and set dataLayer\n * @param dataLayer - The dataLayer\n * @param dataLayerName - The dataLayer name\n */\nexport const getDataLayerSnippet = (\n  dataLayer: Pick<IDataLayer, 'dataLayer'>['dataLayer'],\n  dataLayerName: Pick<IDataLayer, 'dataLayerName'>['dataLayerName'] = 'dataLayer'\n): Pick<ISnippets, 'gtmDataLayer'>['gtmDataLayer'] =>\n  `window.${dataLayerName} = window.${dataLayerName} || [];` +\n  (dataLayer ? `window.${dataLayerName}.push(${JSON.stringify(dataLayer)})` : '')\n\n/**\n * Function to get the Iframe snippet\n * @param environment - The parameters to use a custom environment\n * @param customDomain - Custom domain for gtm\n * @param id - The id of the container\n */\nexport const getIframeSnippet = (\n  id: Pick<ISnippetsParams, 'id'>['id'],\n  environment?: ICustomEnvironmentParams,\n  customDomain: ISnippetsParams['customDomain'] = DEFAULT_DOMAIN\n) => {\n  let params = ``\n  if (environment) {\n    const { gtm_auth, gtm_preview } = environment\n    params = `&gtm_auth=${gtm_auth}&gtm_preview=${gtm_preview}&gtm_cookies_win=x`\n  }\n  return `<iframe src=\"${customDomain}/ns.html?id=${id}${params}\" height=\"0\" width=\"0\" style=\"display:none;visibility:hidden\" id=\"tag-manager\"></iframe>`\n}\n\n/**\n * Function to get the GTM script\n * @param dataLayerName - The name of the dataLayer\n * @param customDomain - Custom domain for gtm\n * @param customScriptName - Custom script file name for gtm\n * @param environment - The parameters to use a custom environment\n * @param id - The id of the container\n */\nexport const getGTMScript = (\n  dataLayerName: Pick<ISnippetsParams, 'dataLayerName'>['dataLayerName'],\n  id: Pick<ISnippetsParams, 'id'>['id'],\n  environment?: ICustomEnvironmentParams,\n  customDomain: ISnippetsParams['customDomain'] = DEFAULT_DOMAIN,\n  customScriptName: ISnippetsParams['customScriptName'] = DEFAULT_SCRIPT_NAME\n) => {\n  let params = ``\n  if (environment) {\n    const { gtm_auth, gtm_preview } = environment\n    params = `+\"&gtm_auth=${gtm_auth}&gtm_preview=${gtm_preview}&gtm_cookies_win=x\"`\n  }\n  return `\n    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':\n      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],\n      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=\n      '${customDomain}/${customScriptName}?id='+i+dl${params};f.parentNode.insertBefore(j,f);\n    })(window,document,'script','${dataLayerName}','${id}');\n  `\n}\n","import { getDataLayerSnippet, getGTMScript, getIframeSnippet } from './snippets'\nimport { ISendToGTM, ISetupGTM, ISnippetsParams } from '../models/GoogleTagManager'\n\n/**\n * Function to setup the Google Tag Manager\n * @param params - The snippets params\n */\nconst setupGTM = (params: ISnippetsParams): ISetupGTM => {\n  const getDataLayerScript = (): HTMLElement => {\n    const dataLayerScript = document.createElement('script')\n    if (params.nonce) {\n      dataLayerScript.setAttribute('nonce', params.nonce)\n    }\n    dataLayerScript.innerHTML = getDataLayerSnippet(params.dataLayer, params.dataLayerName)\n    return dataLayerScript\n  }\n\n  const getNoScript = (): HTMLElement => {\n    const noScript = document.createElement('noscript')\n    noScript.innerHTML = getIframeSnippet(params.id, params.environment, params.customDomain)\n    return noScript\n  }\n\n  const getScript = (): HTMLElement => {\n    const script = document.createElement('script')\n    if (params.nonce) {\n      script.setAttribute('nonce', params.nonce)\n    }\n    script.innerHTML = getGTMScript(\n      params.dataLayerName,\n      params.id,\n      params.environment,\n      params.customDomain,\n      params.customScriptName\n    )\n    return script\n  }\n\n  return {\n    getDataLayerScript,\n    getNoScript,\n    getScript\n  }\n}\n\n/**\n * Function to init the GTM\n * @param dataLayer - The dataLayer\n * @param dataLayerName - The dataLayer name\n * @param environment - Specify the custom environment to use\n * @param nonce - Server-generated nonce\n * @param id - The ID of the GTM\n */\nexport const initGTM = ({\n  dataLayer,\n  dataLayerName,\n  environment,\n  nonce,\n  id,\n  customDomain,\n  customScriptName\n}: ISnippetsParams): void => {\n  const gtm = setupGTM({\n    dataLayer,\n    dataLayerName,\n    environment,\n    nonce,\n    id,\n    customDomain,\n    customScriptName\n  })\n\n  const dataLayerScript = gtm.getDataLayerScript()\n  const script = gtm.getScript()\n  const noScript = gtm.getNoScript()\n\n  document.head.insertBefore(dataLayerScript, document.head.childNodes[0])\n  document.head.insertBefore(script, document.head.childNodes[1])\n  document.body.insertBefore(noScript, document.body.childNodes[0])\n}\n\n/**\n * Function to send the events to the GTM\n * @param dataLayerName - The dataLayer name\n * @param data - The data to push\n */\nexport const sendToGTM = ({ dataLayerName, data }: ISendToGTM): void => {\n  if (window[dataLayerName]) {\n    window[dataLayerName].push(data)\n  } else {\n    console.warn(`dataLayer ${dataLayerName} does not exist, has script be initialized`)\n  }\n}\n","import React, { Context, ReactNode, createContext, useEffect, useContext, useReducer } from 'react'\n\nimport { ISendToGTM, ISnippetsParams } from './models/GoogleTagManager'\nimport { initGTM, sendToGTM } from './utils/GoogleTagManager'\n\ndeclare global {\n  interface Window {\n    dataLayer: Object | undefined\n    [key: string]: any\n  }\n}\n\n/**\n * The shape of the context provider\n */\ntype GTMHookProviderProps = { state?: ISnippetsParams; children: ReactNode }\n\n/**\n * The shape of the hook\n */\nexport type IUseGTM = {\n  UseGTMHookProvider: ({ children }: GTMHookProviderProps) => JSX.Element\n  GTMContext: Context<ISnippetsParams | undefined>\n}\n\n/**\n * The initial state\n */\nexport const initialState: ISnippetsParams = {\n  dataLayer: undefined,\n  dataLayerName: 'dataLayer',\n  environment: undefined,\n  nonce: undefined,\n  id: '',\n  injectScript: true\n}\n\n/**\n * The context\n */\nexport const GTMContext = createContext<ISnippetsParams | undefined>(initialState)\nexport const GTMContextDispatch = createContext<((data: ISendToGTM['data']) => void) | undefined>(undefined)\n\nfunction dataReducer(state: ISnippetsParams, data: any) {\n  sendToGTM({ data, dataLayerName: state?.dataLayerName! })\n  return state\n}\n\n/**\n * The Google Tag Manager Provider\n */\nfunction GTMProvider({ state, children }: GTMHookProviderProps): JSX.Element {\n  const [store, dispatch] = useReducer(dataReducer, { ...initialState, ...state })\n\n  useEffect(() => {\n    if (!state || state.injectScript == false) return\n    const mergedState = { ...store, ...state }\n\n    initGTM(mergedState)\n  }, [JSON.stringify(state)])\n\n  return (\n    <GTMContext.Provider value={store}>\n      <GTMContextDispatch.Provider value={dispatch}>{children}</GTMContextDispatch.Provider>\n    </GTMContext.Provider>\n  )\n}\n\nfunction useGTMDispatch() {\n  const context = useContext(GTMContextDispatch)\n  if (context === undefined) {\n    throw new Error('dispatchGTMEvent must be used within a GTMProvider')\n  }\n\n  return context\n}\n\nexport { GTMProvider, useGTMDispatch, sendToGTM }\n"],"names":["DEFAULT_DOMAIN","DEFAULT_SCRIPT_NAME","getDataLayerSnippet","dataLayer","dataLayerName","JSON","stringify","getIframeSnippet","id","environment","customDomain","params","gtm_auth","gtm_preview","getGTMScript","customScriptName","setupGTM","getDataLayerScript","dataLayerScript","document","createElement","nonce","setAttribute","innerHTML","getNoScript","noScript","getScript","script","initGTM","_ref","gtm","head","insertBefore","childNodes","body","sendToGTM","_ref2","data","window","push","console","warn","initialState","undefined","injectScript","GTMContext","createContext","GTMContextDispatch","dataReducer","state","GTMProvider","children","_useReducer","useReducer","_extends","store","dispatch","useEffect","mergedState","React","Provider","value","useGTMDispatch","context","useContext","Error"],"mappings":"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"}